<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>야구 기록지</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
        }
        .controls {
            margin-bottom: 20px;
        }
        .player-select {
            padding: 5px;
            margin-right: 10px;
        }
        .result-cell {
            position: relative;
            cursor: pointer;
            z-index: 1;
        }
        .result-cell:hover {
            background-color: #f0f0f0;
        }
        .stats {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
        }
        .popup {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
        }
        .save-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .save-btn:hover {
            background-color: #45a049;
        }
        th {
            background-color: #f2f2f2;
            padding: 10px;
            font-weight: bold;
        }
        .result-cell::before {
            content: attr(data-inning);
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #666;
        }
        .game-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .game-info input, .game-info select {
            padding: 5px;
            margin: 5px;
        }

        .pitch-count {
            font-size: 12px;
            color: #666;
            display: block;
        }

        .result-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .result-input-group label {
            font-size: 14px;
        }

        #resultPopup {
            padding: 15px;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
        }

        .result-buttons {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .result-buttons h4 {
            margin: 5px 0;
            color: #666;
        }

        .result-buttons button {
            margin: 3px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
            cursor: pointer;
        }

        .result-buttons button:hover {
            background: #f0f0f0;
        }

        #pitcherInfo {
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
        }

        .pitcher-entry {
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 10px 0;
        }

        .number-grid button {
            padding: 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        .current-pitcher-info {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        #displayCurrentPitcher {
            font-weight: bold;
            color: #333;
        }

        .number-pad {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 10px 0;
        }

        .number-grid button {
            padding: 15px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            font-size: 16px;
        }

        .number-grid button:hover {
            background: #f0f0f0;
        }

        .result-buttons button {
            margin: 3px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
            cursor: pointer;
        }

        .result-buttons button:hover {
            background: #f0f0f0;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
        }

        .player-input, .pitcher-input {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .player-list, .pitcher-history {
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item, .pitcher-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .delete-btn {
            color: red;
            cursor: pointer;
            padding: 2px 6px;
            border: none;
            background: none;
        }

        .count-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;  /* 상하 여백 조정 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .count-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .count-controls {
            display: flex;
            gap: 30px;  /* 간격 증가 */
            margin: 10px 0;
            justify-content: center;
        }

        .count-item {
            text-align: center;
        }

        .count-item label {
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .current-count {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .current-count span {
            padding: 5px 10px;
            background: #fff;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* 스코어보드 스타일 */
        .scoreboard {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .scoreboard h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .score-table th, .score-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 30px;
        }

        .score-table th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        .score-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .score-cell:hover {
            background-color: #f0f0f0;
        }

        /* 점수 입력 모달 */
        .score-input-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .extra-base-hits {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .extra-base-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .extra-base-buttons button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .extra-base-buttons button:hover {
            background-color: #f0f0f0;
        }

        .fielder-selection {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .fielder-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .fielder-buttons button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .fielder-buttons button:hover {
            background-color: #f0f0f0;
        }

        /* 투구 기록 관련 스타일 */
        .pitch-history {
            font-size: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 3px;
        }

        .pitch-record {
            padding: 1px 3px;
            border-radius: 2px;
            font-family: monospace;
        }

        .pitch-record.breaking {
            color: red;
        }

        .pitch-record.fastball {
            color: black;
        }

        .pitch-input-group {
            padding: 10px;
        }

        .pitch-type-buttons, .pitch-result-buttons {
            margin: 10px 0;
        }

        .pitch-type-buttons button, .pitch-result-buttons button {
            margin: 3px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
        }

        .breaking-group {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #eee;
        }

        /* 결과 셀 스타일 수정 */
        .result-cell {
            position: relative;
            min-height: 50px;
        }

        .pitch-history {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
        }

        .popup-divider {
            margin: 15px 0;
            border: none;
            border-top: 1px solid #ddd;
        }

        .pitch-input-group {
            margin-bottom: 15px;
        }

        .pitch-type-buttons button, 
        .pitch-result-buttons button {
            margin: 3px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background: white;
        }

        .pitch-type-buttons button:hover, 
        .pitch-result-buttons button:hover {
            background: #f0f0f0;
        }

        .breaking-group {
            margin-top: 8px;
        }

        .pitch-history {
            font-size: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 3px;
        }

        .pitch-record {
            padding: 1px 3px;
            border-radius: 2px;
            font-family: monospace;
        }

        .pitch-record.breaking {
            color: red;
        }

        .pitch-record.fastball {
            color: black;
        }

        .pitch-detail-popup {
            position: fixed;     /* fixed 유지 */
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            width: 250px;
            max-height: 80vh;   /* 최대 높이 제한 */
            overflow-y: auto;   /* 내용이 많으면 스크롤 */
        }

        .popup-header {
            cursor: move;
            padding: 5px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            margin: -15px -15px 10px -15px;
            border-radius: 8px 8px 0 0;
        }

        .batter-info {
            font-size: 14px;
            font-weight: bold;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .pitch-sequence {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .pitch-record {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 3px;
            background: #f8f9fa;
            border: 1px solid #eee;
        }

        .detail-close {
            position: absolute;
            right: 8px;
            top: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
        }

        /* 경기통계 스타일 */
        .game-stats {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-info">
            <h2>경기 정보</h2>
            <div>
                <input type="date" id="gameDate" required>
                <input type="time" id="gameTime" required>
            </div>
            <div>
                <label>홈팀: </label>
                <input type="text" id="homeTeam" placeholder="홈팀 이름">
                <label>원정팀: </label>
                <input type="text" id="awayTeam" placeholder="원정팀 이름">
            </div>
            <div>
                <label>구장: </label>
                <input type="text" id="stadium" placeholder="경기장">
                <label>날씨: </label>
                <select id="weather">
                    <option value="맑음">맑음</option>
                    <option value="흐림">흐림</option>
                    <option value="비">비</option>
                </select>
            </div>
        </div>

        <div class="pitcher-info">
            <h3>투수 기록</h3>
            <div class="pitcher-input">
                <input type="text" id="currentPitcher" placeholder="투수 이름">
                <select id="inningSelect">
                    <option value="1">1회초</option>
                    <option value="1.5">1회말</option>
                    <option value="2">2회초</option>
                    <option value="2.5">2회말</option>
                    <!-- 9회까지 추가 -->
                </select>
                <button onclick="addPitcherChange()">투수 교체</button>
            </div>
            <div id="pitcherHistory" class="pitcher-history">
                <!-- 투수 교체 기록이 여기에 표시됨 -->
            </div>
        </div>

        <div class="scoreboard">
            <h3>득점표</h3>
            <table class="score-table">
                <tr>
                    <th>팀</th>
                    <th>1</th>
                    <th>2</th>
                    <th>3</th>
                    <th>4</th>
                    <th>5</th>
                    <th>6</th>
                    <th>7</th>
                    <th>8</th>
                    <th>9</th>
                    <th>R</th>
                    <th>H</th>
                    <th>E</th>
                </tr>
                <tr id="awayTeamScore">
                    <td id="awayTeamName">원정팀</td>
                    <td onclick="updateScore('away', 1)" class="score-cell">0</td>
                    <td onclick="updateScore('away', 2)" class="score-cell">0</td>
                    <td onclick="updateScore('away', 3)" class="score-cell">0</td>
                    <td onclick="updateScore('away', 4)" class="score-cell">0</td>
                    <td onclick="updateScore('away', 5)" class="score-cell">0</td>
                    <td onclick="updateScore('away', 6)" class="score-cell">0</td>
                    <td onclick="updateScore('away', 7)" class="score-cell">0</td>
                    <td onclick="updateScore('away', 8)" class="score-cell">0</td>
                    <td onclick="updateScore('away', 9)" class="score-cell">0</td>
                    <td id="awayR">0</td>
                    <td id="awayH">0</td>
                    <td id="awayE" onclick="updateError('away')">0</td>
                </tr>
                <tr id="homeTeamScore">
                    <td id="homeTeamName">홈팀</td>
                    <td onclick="updateScore('home', 1)" class="score-cell">0</td>
                    <td onclick="updateScore('home', 2)" class="score-cell">0</td>
                    <td onclick="updateScore('home', 3)" class="score-cell">0</td>
                    <td onclick="updateScore('home', 4)" class="score-cell">0</td>
                    <td onclick="updateScore('home', 5)" class="score-cell">0</td>
                    <td onclick="updateScore('home', 6)" class="score-cell">0</td>
                    <td onclick="updateScore('home', 7)" class="score-cell">0</td>
                    <td onclick="updateScore('home', 8)" class="score-cell">0</td>
                    <td onclick="updateScore('home', 9)" class="score-cell">0</td>
                    <td id="homeR">0</td>
                    <td id="homeH">0</td>
                    <td id="homeE" onclick="updateError('home')">0</td>
                </tr>
            </table>
        </div>

        <div class="count-display">
            <div class="count-group">
                <h3>현재 카운트</h3>
                <div class="count-controls">
                    <div class="count-item">
                        <label>B</label>
                        <div class="count-buttons">
                            <button class="count-btn" onclick="setBallCount(0)">0</button>
                            <button class="count-btn" onclick="setBallCount(1)">1</button>
                            <button class="count-btn" onclick="setBallCount(2)">2</button>
                            <button class="count-btn" onclick="setBallCount(3)">3</button>
                        </div>
                    </div>
                    <div class="count-item">
                        <label>S</label>
                        <div class="count-buttons">
                            <button class="count-btn" onclick="setStrikeCount(0)">0</button>
                            <button class="count-btn" onclick="setStrikeCount(1)">1</button>
                            <button class="count-btn" onclick="setStrikeCount(2)">2</button>
                        </div>
                    </div>
                    <div class="count-item">
                        <label>O</label>
                        <div class="count-buttons">
                            <button class="count-btn" onclick="setOutCount(0)">0</button>
                            <button class="count-btn" onclick="setOutCount(1)">1</button>
                            <button class="count-btn" onclick="setOutCount(2)">2</button>
                        </div>
                    </div>
                </div>
                <div class="current-count">
                    <span id="ballCount">B: 0</span>
                    <span id="strikeCount">S: 0</span>
                    <span id="outCount">O: 0</span>
                </div>
            </div>
        </div>

        <table id="scoreTable">
            <!-- 테이블 헤더 -->
            <tr>
                <th rowspan="2">타순</th>
                <th rowspan="2">선수명</th>
                <th rowspan="2">포지션</th>
                <th colspan="9">이닝</th>
                <th rowspan="2">타수</th>
                <th rowspan="2">안타</th>
                <th rowspan="2">타율</th>
            </tr>
            <tr>
                <th>1</th>
                <th>2</th>
                <th>3</th>
                <th>4</th>
                <th>5</th>
                <th>6</th>
                <th>7</th>
                <th>8</th>
                <th>9</th>
            </tr>
            <!-- 선수 행은 JavaScript로 동적 생성됨 -->
        </table>

        <div class="stats" id="gameStats">
            <h3>경기 통계</h3>
            <p>팀 타율: <span id="teamAvg">0.000</span></p>
            <p>팀 출루율: <span id="teamOBP">0.000</span></p>
        </div>
    </div>

    <!-- 결과 입력 팝업 -->
    <div id="resultPopup" class="popup">
        <!-- 투구 기록 섹션 추가 -->
        <div class="pitch-input-group">
            <h4>투구 기록</h4>
            <div class="pitch-type-buttons">
                <h5>구종 선택</h5>
                <div class="fastball-group">
                    <button onclick="selectPitch('직구', false)">직구</button>
                </div>
                <div class="breaking-group">
                    <button onclick="selectPitch('슬라이더', true)">슬라이더</button>
                    <button onclick="selectPitch('커브', true)">커브</button>
                    <button onclick="selectPitch('체인지업', true)">체인지업</button>
                    <button onclick="selectPitch('포크', true)">포크</button>
                </div>
            </div>
            <div class="pitch-result-buttons">
                <h5>투구 결과</h5>
                <button onclick="setPitchResult('s')">스트라이크(S)</button>
                <button onclick="setPitchResult('b')">볼(B)</button>
                <button onclick="setPitchResult('f')">파울(F)</button>
            </div>
        </div>

        <hr class="popup-divider">

        <!-- 기존 타석 결과 입력 그룹 -->
        <div class="result-input-group">
            <h4>타석 결과</h4>
            <label>투구 수: <input type="number" id="pitchCount" min="1" max="20" value="1"></label>
            <div class="result-buttons">
                <h4>결과 선택</h4>
                <button onclick="selectResultType('안타')">안타</button>
                <button onclick="showExtraBaseHits('2루타')">2루타</button>
                <button onclick="showExtraBaseHits('3루타')">3루타</button>
                <button onclick="setResult('홈런')">홈런</button>
                <button onclick="selectResultType('땅볼아웃')">땅볼아웃</button>
                <button onclick="selectResultType('플라이아웃')">플라이아웃</button>
                <button onclick="selectResultType('실책')">실책</button>
                <button onclick="selectResultType('야수선택')">야수선택</button>
                <button onclick="setResult('삼진')">삼진</button>
                <button onclick="setResult('볼넷')">볼넷</button>
                <button onclick="setResult('사구')">사구</button>
                <button onclick="setResult('희생번트')">희생번트</button>
                <button onclick="setResult('희생플라이')">희생플라이</button>
            </div>

            <!-- 수비수 선택 패드 (실책/야수선택용) -->
            <div id="fielderSelection" class="fielder-selection" style="display: none;">
                <h4>수비수 선택</h4>
                <div class="fielder-buttons">
                    <button onclick="setFielderResult('1')">투수(1)</button>
                    <button onclick="setFielderResult('2')">포수(2)</button>
                    <button onclick="setFielderResult('3')">1루수(3)</button>
                    <button onclick="setFielderResult('4')">2루수(4)</button>
                    <button onclick="setFielderResult('5')">3루수(5)</button>
                    <button onclick="setFielderResult('6')">유격수(6)</button>
                    <button onclick="setFielderResult('7')">좌익수(7)</button>
                    <button onclick="setFielderResult('8')">중견수(8)</button>
                    <button onclick="setFielderResult('9')">우익수(9)</button>
                </div>
            </div>

            <!-- 기존의 다른 선택 패널들 -->
            <div id="extraBaseHits" class="extra-base-hits" style="display: none;">
                <h4 id="extraBaseTitle">2루타 종류</h4>
                <div class="extra-base-buttons">
                    <button onclick="setExtraBaseHit('좌중간')">좌중간</button>
                    <button onclick="setExtraBaseHit('우중간')">우중간</button>
                    <button onclick="setExtraBaseHit('좌선상')">좌선상</button>
                    <button onclick="setExtraBaseHit('우선상')">우선상</button>
                </div>
            </div>

            <div id="firstPosition" class="number-pad" style="display: none;">
                <h4>첫 번째 숫자 선택</h4>
                <div class="number-grid">
                    <button onclick="selectFirstPosition(1)">1</button>
                    <button onclick="selectFirstPosition(2)">2</button>
                    <button onclick="selectFirstPosition(3)">3</button>
                    <button onclick="selectFirstPosition(4)">4</button>
                    <button onclick="selectFirstPosition(5)">5</button>
                    <button onclick="selectFirstPosition(6)">6</button>
                    <button onclick="selectFirstPosition(7)">7</button>
                    <button onclick="selectFirstPosition(8)">8</button>
                    <button onclick="selectFirstPosition(9)">9</button>
                </div>
            </div>

            <div id="secondPosition" class="number-pad" style="display: none;">
                <h4>두 번째 숫자 선택</h4>
                <div class="number-grid">
                    <button onclick="selectSecondPosition(1)">1</button>
                    <button onclick="selectSecondPosition(2)">2</button>
                    <button onclick="selectSecondPosition(3)">3</button>
                    <button onclick="selectSecondPosition(4)">4</button>
                    <button onclick="selectSecondPosition(5)">5</button>
                    <button onclick="selectSecondPosition(6)">6</button>
                    <button onclick="selectSecondPosition(7)">7</button>
                    <button onclick="selectSecondPosition(8)">8</button>
                    <button onclick="selectSecondPosition(9)">9</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 선수 명단 관리 모달 추가 -->
    <div id="playerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>선수 명단 관리</h2>
            <div class="player-input">
                <input type="text" id="playerName" placeholder="선수 이름">
                <input type="text" id="playerPosition" placeholder="포지션">
                <button onclick="addPlayer()">선수 추가</button>
            </div>
            <div id="playerList" class="player-list">
                <!-- 선수 목록이 여기에 표시됨 -->
            </div>
            <button onclick="closePlayerModal()">닫기</button>
        </div>
    </div>

    <!-- 투구 기록 입력을 위한 팝업 추가 -->
    <div id="pitchPopup" class="popup">
        <div class="pitch-input-group">
            <h4>투구 기록</h4>
            <div class="pitch-type-buttons">
                <h5>구종 선택</h5>
                <div class="fastball-group">
                    <button onclick="selectPitch('직구', false)">직구</button>
                </div>
                <div class="breaking-group">
                    <button onclick="selectPitch('슬라이더', true)">슬라이더</button>
                    <button onclick="selectPitch('커브', true)">커브</button>
                    <button onclick="selectPitch('체인지업', true)">체인지업</button>
                    <button onclick="selectPitch('포크', true)">포크</button>
                </div>
            </div>
            <div class="pitch-result-buttons">
                <h5>결과</h5>
                <button onclick="setPitchResult('s')">스트라이크(S)</button>
                <button onclick="setPitchResult('b')">볼(B)</button>
                <button onclick="setPitchResult('f')">파울(F)</button>
            </div>
        </div>
    </div>

    <script src="popup.js"></script>
    <script>
        let currentCell = null;
        let players = [
            { id: 1, name: "이동기", position: "LF" },
            { id: 2, name: "김철수", position: "CF" },
            { id: 3, name: "박지성", position: "RF" },
            { id: 4, name: "최우철", position: "3B" },
            { id: 5, name: "오성민", position: "SS" },
            { id: 6, name: "이민재", position: "2B" },
            { id: 7, name: "조현우", position: "1B" },
            { id: 8, name: "강민호", position: "C" },
            { id: 9, name: "손흥민", position: "DH" }
        ];

        let gameData = {
            date: new Date(),
            results: {}
        };

        let pitchers = [];
        let currentInningPitcher = '';
        let currentOutType = '';
        let currentResultType = '';
        let firstPositionNumber = null;
        let pitcherHistory = [];

        // 카운트 관리를 위한 변수
        let currentBalls = 0;
        let currentStrikes = 0;
        let currentOuts = 0;

        // 스코어 관리를 위한 변수
        let scores = {
            away: Array(9).fill(0),
            home: Array(9).fill(0),
            awayE: 0,
            homeE: 0
        };

        let currentHitType = '';

        let currentPitchType = '';
        let isBreaking = false;
        let pitchHistory = {};
        let currentDetailPopup = null;

        let popupPosition = { x: 100, y: 100 }; // 기본 위치
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;

        function initializeTable() {
            const table = document.getElementById('scoreTable');
            players.forEach((player, index) => {
                const row = table.insertRow(-1);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.name}</td>
                    <td>${player.position}</td>
                    ${Array(9).fill('').map((_, i) => 
                        `<td class="result-cell" data-inning="${i+1}" onclick="showResultPopup(this)"></td>`
                    ).join('')}
                    <td class="at-bats">0</td>
                    <td class="hits">0</td>
                    <td class="avg">0.000</td>
                `;
            });
        }

        function showResultPopup(cell) {
            currentCell = cell;
            document.getElementById('resultPopup').style.display = 'block';
            
            // 현재 셀의 투구 기록 표시
            if (!cell.id) {
                cell.id = 'cell_' + Date.now();
            }
            if (!pitchHistory[cell.id]) {
                pitchHistory[cell.id] = [];
            }
            updatePitchDisplay(cell);
        }

        function addPitcherChange() {
            const pitcherName = document.getElementById('currentPitcher').value;
            const inning = document.getElementById('inningSelect').value;
            
            if (pitcherName) {
                const pitcherEntry = {
                    id: Date.now(),
                    name: pitcherName,
                    inning: inning,
                    timestamp: new Date().toISOString()
                };
                
                pitcherHistory.push(pitcherEntry);
                document.getElementById('currentPitcher').value = '';
                
                displayPitcherHistory();
                savePitcherHistoryToStorage();
            }
        }

        function selectResultType(type) {
            currentResultType = type;
            if (type === '실책' || type === '야수선택') {
                document.getElementById('fielderSelection').style.display = 'block';
                document.getElementById('firstPosition').style.display = 'none';
                document.getElementById('secondPosition').style.display = 'none';
                document.getElementById('extraBaseHits').style.display = 'none';
            } else {
                // 기존의 다른 타입 처리
                document.getElementById('fielderSelection').style.display = 'none';
                if (type === '땅볼아웃' || type === '플라이아웃' || type === '안타') {
                    document.getElementById('firstPosition').style.display = 'block';
                }
            }
        }

        function selectFirstPosition(number) {
            firstPositionNumber = number;
            if (currentResultType === '땅볼아웃') {
                document.getElementById('secondPosition').style.display = 'block';
            } else {
                // 안타나 다른 결과는 첫 번째 숫자만으로 완성
                setFinalResult(`${currentResultType} (${number})`);
            }
        }

        function selectSecondPosition(number) {
            if (firstPositionNumber !== null) {
                if (currentResultType === '땅볼아웃') {
                    setFinalResult(`${firstPositionNumber}-${number} 땅볼아웃`);
                } else if (currentResultType === '플라이아웃') {
                    setFinalResult(`${number} 플라이아웃`);
                }
            }
        }

        function setFinalResult(result) {
            if (currentCell) {
                const pitchCount = document.getElementById('pitchCount').value;
                const countDisplay = `(B:${currentBalls} S:${currentStrikes})`;
                currentCell.innerHTML = `
                    <div>${result}</div>
                    <span class="pitch-count">${pitchCount}구 ${countDisplay}</span>
                `;
                updateStats(currentCell.parentElement);
                resetPopup();
                
                // 결과 기록 후 볼카운트 리셋
                setBallCount(0);
                setStrikeCount(0);
                if (result.includes('아웃')) {
                    setOutCount((currentOuts + 1) % 3);
                }
            }
        }

        function setResult(result) {
            if (currentCell) {
                const pitchCount = document.getElementById('pitchCount').value;
                const countDisplay = `(B:${currentBalls} S:${currentStrikes})`;
                
                // 기본 결과 표시
                currentCell.innerHTML = `
                    <div class="result-text">${result}</div>
                    <span class="pitch-count">${pitchCount}구 ${countDisplay}</span>
                `;
                
                // 상세 정보를 보기 위한 클릭 이벤트 추가
                currentCell.onclick = function(e) {
                    if (e.target.classList.contains('detail-close')) return;
                    showPitchDetail(this, e);
                };
                
                updateStats(currentCell.parentElement);
                document.getElementById('resultPopup').style.display = 'none';
                
                // 볼카운트 리셋
                setBallCount(0);
                setStrikeCount(0);
            }
        }

        function resetPopup() {
            document.getElementById('fielderSelection').style.display = 'none';
            document.getElementById('resultPopup').style.display = 'none';
            document.getElementById('firstPosition').style.display = 'none';
            document.getElementById('secondPosition').style.display = 'none';
            document.getElementById('extraBaseHits').style.display = 'none';
            currentResultType = '';
            currentHitType = '';
            firstPositionNumber = null;
            currentPitchType = '';
            isBreaking = false;
            document.getElementById('pitchPopup').style.display = 'none';
        }

        function updateStats(row) {
            let atBats = 0;
            let hits = 0;
            
            // 결과 셀들을 순회하며 타수와 안타 계산
            row.querySelectorAll('.result-cell').forEach(cell => {
                const result = cell.textContent.split('구')[0]; // '구' 이전의 텍스트만 저장
                if (result && result !== '볼넷') {
                    atBats++;
                    if (['안타', '2루타', '3루타', '홈런'].includes(result)) {
                        hits++;
                    }
                }
            });

            // 통계 업데이트
            row.querySelector('.at-bats').textContent = atBats;
            row.querySelector('.hits').textContent = hits;
            row.querySelector('.avg').textContent = 
                atBats > 0 ? (hits / atBats).toFixed(3) : '.000';

            updateTeamStats();
        }

        function updateTeamStats() {
            let totalAtBats = 0;
            let totalHits = 0;

            document.querySelectorAll('tr').forEach(row => {
                const atBats = parseInt(row.querySelector('.at-bats')?.textContent || 0);
                const hits = parseInt(row.querySelector('.hits')?.textContent || 0);
                totalAtBats += atBats;
                totalHits += hits;
            });

            document.getElementById('teamAvg').textContent = 
                totalAtBats > 0 ? (totalHits / totalAtBats).toFixed(3) : '.000';
        }

        function saveGame() {
            const gameData = {
                date: document.getElementById('gameDate').value,
                time: document.getElementById('gameTime').value,
                homeTeam: document.getElementById('homeTeam').value,
                awayTeam: document.getElementById('awayTeam').value,
                stadium: document.getElementById('stadium').value,
                weather: document.getElementById('weather').value,
                players: []
            };

            // 테이블의 데이터를 수집
            document.querySelectorAll('tr').forEach((row, index) => {
                if (index <= 1) return; // 헤더 행 스킵

                const playerData = {
                    name: row.cells[1].textContent,
                    position: row.cells[2].textContent,
                    results: []
                };

                // 이닝별 결과 수집
                for (let i = 3; i < 12; i++) {
                    const cell = row.cells[i];
                    const result = cell.textContent.split('구')[0]; // '구' 이전의 텍스트만 저장
                    const pitchCount = cell.querySelector('.pitch-count')?.textContent || '';
                    playerData.results.push({
                        result: result,
                        pitchCount: pitchCount
                    });
                }

                gameData.players.push(playerData);
            });

            // localStorage에 저장
            const games = JSON.parse(localStorage.getItem('baseballGames') || '[]');
            games.push(gameData);
            localStorage.setItem('baseballGames', JSON.stringify(games));
            alert('경기가 저장되었습니다!');
        }

        function loadPlayerList() {
            openPlayerModal();
        }

        function openPlayerModal() {
            document.getElementById('playerModal').style.display = 'block';
            displayPlayers();
        }

        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
        }

        function addPlayer() {
            const name = document.getElementById('playerName').value;
            const position = document.getElementById('playerPosition').value;
            
            if (name && position) {
                players.push({
                    id: Date.now(),
                    name: name,
                    position: position
                });
                
                document.getElementById('playerName').value = '';
                document.getElementById('playerPosition').value = '';
                
                displayPlayers();
                savePlayersToStorage();
            }
        }

        function deletePlayer(id) {
            players = players.filter(player => player.id !== id);
            displayPlayers();
            savePlayersToStorage();
        }

        function displayPlayers() {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = players.map(player => `
                <div class="player-item">
                    <span>${player.name} (${player.position})</span>
                    <button class="delete-btn" onclick="deletePlayer(${player.id})">×</button>
                </div>
            `).join('');
        }

        function displayPitcherHistory() {
            const historyDiv = document.getElementById('pitcherHistory');
            historyDiv.innerHTML = pitcherHistory
                .sort((a, b) => parseFloat(a.inning) - parseFloat(b.inning))
                .map(entry => `
                    <div class="pitcher-item">
                        <span>${getInningDisplay(entry.inning)} : ${entry.name}</span>
                        <button class="delete-btn" onclick="deletePitcher(${entry.id})">×</button>
                    </div>
                `).join('');
        }

        function getInningDisplay(inning) {
            const fullInning = Math.floor(parseFloat(inning));
            const isBottom = (parseFloat(inning) % 1) !== 0;
            return `${fullInning}회${isBottom ? '말' : '초'}`;
        }

        function deletePitcher(id) {
            pitcherHistory = pitcherHistory.filter(pitcher => pitcher.id !== id);
            displayPitcherHistory();
            savePitcherHistoryToStorage();
        }

        function savePlayersToStorage() {
            localStorage.setItem('baseballPlayers', JSON.stringify(players));
        }

        function savePitcherHistoryToStorage() {
            localStorage.setItem('pitcherHistory', JSON.stringify(pitcherHistory));
        }

        function loadFromStorage() {
            const storedPlayers = localStorage.getItem('baseballPlayers');
            if (storedPlayers) {
                players = JSON.parse(storedPlayers);
            }
            
            const storedPitchers = localStorage.getItem('pitcherHistory');
            if (storedPitchers) {
                pitcherHistory = JSON.parse(storedPitchers);
            }
            
            displayPlayers();
            displayPitcherHistory();
        }

        function setBallCount(count) {
            currentBalls = count;
            updateCountDisplay();
            document.querySelectorAll('.count-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="setBallCount(${count})"]`).classList.add('active');
        }

        function setStrikeCount(count) {
            currentStrikes = count;
            updateCountDisplay();
            document.querySelectorAll('.count-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="setStrikeCount(${count})"]`).classList.add('active');
        }

        function setOutCount(count) {
            currentOuts = count;
            updateCountDisplay();
            document.querySelectorAll('.count-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="setOutCount(${count})"]`).classList.add('active');
        }

        function updateCountDisplay() {
            document.getElementById('ballCount').textContent = `B: ${currentBalls}`;
            document.getElementById('strikeCount').textContent = `S: ${currentStrikes}`;
            document.getElementById('outCount').textContent = `O: ${currentOuts}`;
        }

        function updateScore(team, inning) {
            const newScore = prompt(`${team === 'away' ? '원정팀' : '홈팀'} ${inning}회 득점:`);
            if (newScore !== null && !isNaN(newScore)) {
                const scoreNum = parseInt(newScore);
                scores[team][inning-1] = scoreNum;
                updateScoreboard();
            }
        }

        function updateError(team) {
            scores[`${team}E`]++;
            document.getElementById(`${team}E`).textContent = scores[`${team}E`];
        }

        function updateScoreboard() {
            // 각 이닝 점수 업데이트
            for (let i = 0; i < 9; i++) {
                document.querySelector(`#awayTeamScore td:nth-child(${i+2})`).textContent = scores.away[i];
                document.querySelector(`#homeTeamScore td:nth-child(${i+2})`).textContent = scores.home[i];
            }
            
            // 총점 계산 및 업데이트
            const awayTotal = scores.away.reduce((a, b) => a + b, 0);
            const homeTotal = scores.home.reduce((a, b) => a + b, 0);
            
            document.getElementById('awayR').textContent = awayTotal;
            document.getElementById('homeR').textContent = homeTotal;
        }

        function setTeamNames() {
            const awayTeam = document.getElementById('awayTeam').value;
            const homeTeam = document.getElementById('homeTeam').value;
            document.getElementById('awayTeamName').textContent = awayTeam || '원정팀';
            document.getElementById('homeTeamName').textContent = homeTeam || '홈팀';
        }

        function showExtraBaseHits(type) {
            currentHitType = type;
            document.getElementById('extraBaseTitle').textContent = `${type} 종류`;
            document.getElementById('extraBaseHits').style.display = 'block';
            document.getElementById('firstPosition').style.display = 'none';
            document.getElementById('secondPosition').style.display = 'none';
        }

        function setExtraBaseHit(location) {
            const result = `${currentHitType} (${location})`;
            if (currentCell) {
                const pitchCount = document.getElementById('pitchCount').value;
                const countDisplay = `(B:${currentBalls} S:${currentStrikes})`;
                currentCell.innerHTML = `
                    <div>${result}</div>
                    <span class="pitch-count">${pitchCount}구 ${countDisplay}</span>
                `;
                updateStats(currentCell.parentElement);
                resetPopup();
                
                // 볼카운트 리셋
                setBallCount(0);
                setStrikeCount(0);
            }
        }

        function setFielderResult(fielderNumber) {
            if (currentCell) {
                const pitchCount = document.getElementById('pitchCount').value;
                const countDisplay = `(B:${currentBalls} S:${currentStrikes})`;
                let resultText = '';
                
                if (currentResultType === '실책') {
                    resultText = `E${fielderNumber}`;
                    // 실책 카운트 증가
                    const currentInning = getCurrentInning(); // 현재 이닝 확인 함수 필요
                    const team = isHomeTeamBatting() ? 'away' : 'home'; // 수비팀 실책 증가
                    updateError(team);
                } else if (currentResultType === '야수선택') {
                    resultText = `FC${fielderNumber}`;
                }

                currentCell.innerHTML = `
                    <div>${resultText}</div>
                    <span class="pitch-count">${pitchCount}구 ${countDisplay}</span>
                `;
                
                updateStats(currentCell.parentElement);
                resetPopup();
                
                // 볼카운트 리셋
                setBallCount(0);
                setStrikeCount(0);
            }
        }

        function selectPitch(type, breaking) {
            currentPitchType = type;
            isBreaking = breaking;
            // 투구 결과 버튼들 활성화
            document.querySelector('.pitch-result-buttons').style.display = 'block';
        }

        function setPitchResult(result) {
            if (!currentCell || !currentPitchType) return;
            
            if (!currentCell.id) {
                currentCell.id = 'cell_' + Date.now();
            }
            
            if (!pitchHistory[currentCell.id]) {
                pitchHistory[currentCell.id] = [];
            }
            
            // 새 투구 기록 추가
            pitchHistory[currentCell.id].push({
                type: currentPitchType,
                result: result,
                isBreaking: isBreaking
            });
            
            // 볼카운트 업데이트
            updateCount(result);
            
            // localStorage에 투구 기록 저장
            saveToLocalStorage();
        }

        function updatePitchDisplay(cell) {
            // 기존 투구 기록 요소 찾기 또는 생성
            let historyDiv = cell.querySelector('.pitch-history');
            if (!historyDiv) {
                historyDiv = document.createElement('div');
                historyDiv.className = 'pitch-history';
                cell.appendChild(historyDiv);
            }
            
            // 투구 기록 표시
            historyDiv.innerHTML = pitchHistory[cell.id].map(pitch => `
                <span class="pitch-record ${pitch.isBreaking ? 'breaking' : 'fastball'}">
                    ${pitch.result}
                </span>
            `).join('');
        }

        function updateCount(result) {
            if (result === 'b') {
                setBallCount(currentBalls + 1);
            } else if (result === 's') {
                setStrikeCount(currentStrikes + 1);
            } else if (result === 'f' && currentStrikes < 2) {
                setStrikeCount(currentStrikes + 1);
            }
        }

        function showPitchDetail(cell, event) {
            event.stopPropagation();
            popupManager.show(cell, pitchHistory);
        }

        function saveToLocalStorage() {
            localStorage.setItem('pitchHistory', JSON.stringify(pitchHistory));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('pitchHistory');
            if (saved) {
                pitchHistory = JSON.parse(saved);
            }
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            initializeTable();
            loadFromStorage();
            
            // 이닝 선택 옵션 생성
            const inningSelect = document.getElementById('inningSelect');
            for (let i = 1; i <= 9; i++) {
                inningSelect.innerHTML += `
                    <option value="${i}">${i}회초</option>
                    <option value="${i + 0.5}">${i}회말</option>
                `;
            }
            updateCountDisplay();
            
            // 팀 이름 입력 시 스코어보드 업데이트
            document.getElementById('awayTeam').addEventListener('change', setTeamNames);
            document.getElementById('homeTeam').addEventListener('change', setTeamNames);
            
            updateScoreboard();
        };

        // 화면 리사이즈 시 팝업 위치 재조정
        window.addEventListener('resize', function() {
            if (currentDetailPopup && currentDetailPopup.parentElement) {
                const cell = currentDetailPopup.parentElement;
                const cellRect = cell.getBoundingClientRect();
                const popupRect = currentDetailPopup.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                
                if (cellRect.right + popupRect.width > windowWidth) {
                    currentDetailPopup.classList.add('left-side');
                } else {
                    currentDetailPopup.classList.remove('left-side');
                }
            }
        });
    </script>
</body>
</html>

